# NinjaOne Office365 Update Script
# Author: Ruben Munoz
# 10/16/2025

# Variables
$Channel = "Current"
$Language = "en-us"
$ProductID = "O365ProPlusRetail"   # <- correct Product ID
$ExcludeTeamsClassic = $true
$OdtDownloadPage = "https://www.microsoft.com/en-us/download/details.aspx?id=49117" # reference page

[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12

$Root   = "C:\ProgramData\NinjaTemp\O365"
$OdtExe = Join-Path $Root "ODT.exe"
$Cfg    = Join-Path $Root "config.xml"
New-Item -ItemType Directory -Path $Root -Force | Out-Null

# Download the latest ODT (method: follow the official page to the actual .exe; consider hosting a vetted copy internally)
# If you host a stable copy, replace $OdtExe download with that URL.
Invoke-WebRequest -Uri "https://officecdn.microsoft.com/pr/wsus/setup.exe" -OutFile $OdtExe -UseBasicParsing

Start-Process -FilePath $OdtExe -ArgumentList "/quiet /extract:$Root" -Wait
$Setup = Join-Path $Root "setup.exe"
if (-not (Test-Path $Setup)) { throw "setup.exe not found after ODT extract" }

$teamsLine = if ($ExcludeTeamsClassic) { '      <ExcludeApp ID="Teams" />' } else { "" }

$config = @"
<Configuration>
  <Remove All="True" />
  <Add OfficeClientEdition="64" Channel="$Channel" AllowCdnFallback="TRUE">
    <Product ID="$ProductID">
$teamsLine
      <Language ID="$Language" />
      <Property Name="AUTOACTIVATE" Value="1" />
      <Property Name="FORCEAPPSHUTDOWN" Value="TRUE" />
    </Product>
  </Add>
  <RemoveMSI All="True" />
  <Display Level="None" AcceptEULA="True" />
</Configuration>
"@
Set-Content -Path $Cfg -Value $config -Encoding UTF8

Start-Process -FilePath $Setup -ArgumentList "/configure `"$Cfg`"" -Wait
